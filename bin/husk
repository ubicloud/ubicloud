#!/usr/bin/env ruby
# frozen_string_literal: true

child = Process.spawn(*ARGV, close_others: true, in: $stdin, out: $stdout, err: $stderr)

Signal.trap("SIGTERM") do
  Process.kill("SIGTERM", child)
  sleep 2
  begin
    Process.kill("SIGQUIT", child)
  rescue Errno::ESRCH
    puts "husk: subprocess exited normally from SIGTERM"
  end
end

_, status = Process.wait2 child
Kernel.exit!(status.exitstatus || status.termsig + 128)

#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../../common/lib/util"

# Usage: apply-io-throttle <version> <throttle_mbps>
# throttle_mbps: nil/0 = remove throttle, >0 = limit in MB/s
#
# This script manages disk I/O throttling for PostgreSQL via systemd cgroups.
# It creates/updates/removes a systemd drop-in file that limits write bandwidth.
# The WAL-G service runs in a separate systemd unit and is NOT affected.

if ARGV.count != 2
  fail "Wrong number of arguments. Expected 2 (version, throttle_mbps), Given #{ARGV.count}"
end

version = ARGV[0]
throttle_mbps = ARGV[1].to_i

DROPIN_DIR = "/etc/systemd/system/postgresql@.service.d"
DROPIN_FILE = "#{DROPIN_DIR}/io-throttle.conf"

data_disk = r("findmnt -n -o SOURCE /dat").strip

if throttle_mbps == 0
  FileUtils.rm_f(DROPIN_FILE)
else
  r "mkdir -p #{DROPIN_DIR}"

  dropin_content = <<~CONF
    # Auto-generated by Ubicloud for archival backlog management
    # Do not edit manually - changes will be overwritten
    [Service]
    IOWriteBandwidthMax=#{data_disk} #{throttle_mbps}M
  CONF

  safe_write_to_file(DROPIN_FILE, dropin_content)
end

r "systemctl daemon-reload"

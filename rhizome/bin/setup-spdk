#!/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/common"
require_relative "../lib/spdk"
require "fileutils"

# spdk dependencies
r "apt-get -y install libaio-dev libssl-dev libnuma-dev libjson-c-dev uuid-dev libiscsi-dev"

# spdk binaries
FileUtils.cd Spdk.install_prefix do
  r "curl -L3 -o /tmp/spdk.tar.gz https://ubicloud-spdk2.s3.us-east-2.amazonaws.com/spdk.tar.gz"
  r "tar -xzf /tmp/spdk.tar.gz"
end

q_user = Spdk.user.shellescape
q_hugepages_dir = Spdk.hugepages_dir.shellescape

begin
  r "adduser #{q_user} --disabled-password --gecos '' --home #{Spdk.home.shellescape}"
rescue CommandFail => ex
  raise unless /adduser: The user `.*' already exists\./.match?(ex.message)
end

r "sudo --user=#{q_user} mkdir -p #{q_hugepages_dir}"
r "mount -t hugetlbfs -o uid=#{q_user},size=1G nodev #{q_hugepages_dir}"

# Directory to put vhost sockets.
FileUtils.mkdir_p(Spdk.vhost_dir)
FileUtils.chown Spdk.user, Spdk.user, Spdk.vhost_dir

spdk_service = <<SPDK_SERVICE
[Unit]
Description=Block Storage Service
[Service]
Type=simple
Environment="XDG_RUNTIME_DIR=#{Spdk.home.shellescape}"
ExecStart=/opt/spdk/bin/vhost -S #{Spdk.vhost_dir.shellescape} \
--huge-dir #{q_hugepages_dir} \
--iova-mode va \
--rpc-socket #{Spdk.rpc_sock.shellescape} \
--cpumask [0] \
--disable-cpumask-locks
ExecReload=/bin/kill -HUP $MAINPID
LimitMEMLOCK=8400113664
PrivateDevices=yes
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectControlGroups=yes
ProtectHome=no
NoNewPrivileges=yes
User=spdk
Group=spdk
SPDK_SERVICE

File.write("/etc/systemd/system/spdk.service", spdk_service)

name: Trigger E2E tests

permissions:
  contents: read
  actions: write
  pull-requests: write

on:
  issue_comment:
    types: [created]

jobs:
    pr_comment:
      if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/run-e2e')
      runs-on: ubicloud
      steps:
        - name: Trigger E2E tests
          uses: actions/github-script@v8
          with:
            script: |
              // Check if the comment is from a contributor
              const contributors = await github.rest.repos.listContributors({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const contributorIds = contributors.data.map(c => c.id);
              const isContributor = contributorIds.includes(context.payload.comment.user.id);

              // Parse arguments: /run-e2e [providers] [test_cases]
              const args = context.payload.comment.body.trim().split(/\s+/);
              const providers = args[1] || '';
              const testCases = args[2] || '';
              console.log(`providers: ${providers}`);
              console.log(`testCases: ${testCases}`);
              const inputPattern = /^[a-zA-Z0-9_,-]+$/;
              const isValid = (!providers || inputPattern.test(providers)) && (!testCases || inputPattern.test(testCases));
              console.log(`Is valid: ${isValid}`);

              const allowedToRun = isContributor && isValid;

              // Add a reaction to the comment
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: allowedToRun ? 'rocket' : '-1'
              })

              if (!allowedToRun) {
                console.log('Not allowed to run E2E tests');
                process.exit(1);
              }

              // Get pull request details
              const pullRequest = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });

              // Create a workflow dispatch event
              const inputs = {}
              if (providers) inputs.providers = providers;
              if (testCases) inputs.test_cases = testCases;
              const dispatch = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e.yml',
                ref: pullRequest.data.head.ref,
                inputs: inputs,
                return_run_details: true
              });

              // Append the workflow run URL to the original comment
              if (dispatch.data?.html_url) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  body: `${context.payload.comment.body}\n\nE2E tests triggered: ${dispatch.data.html_url}`
                });
              }

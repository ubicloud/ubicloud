<% @page_title = "#{@project.name} - Users"
@users = @project.accounts_dataset.order_by(:email).all
@subject_tag_map = SubjectTag.subject_id_map_for_project_and_accounts(@project.id, @users.map(&:id))
@allowed_view_tag_names = dataset_authorize(@project.subject_tags_dataset, "SubjectTag:view").map(:name)
@allowed_add_tag_names_map = dataset_authorize(@project.subject_tags_dataset, "SubjectTag:add").select_hash(:name, Sequel.as(true, :v))
@allowed_remove_tag_names_map = dataset_authorize(@project.subject_tags_dataset, "SubjectTag:remove").select_hash(:name, Sequel.as(true, :v))
@invitations = @project.invitations_dataset.order_by(:email).all %>
<%== render("project/user-tabbar") %>

<%== part(
  "components/page_header",
  title: "User Management",
  breadcrumbs: [%w[Projects /project], [@project.name, @project.path], %w[Users #]]
) %>

<div class="content-grid">
  <!-- Invite user -->
  <div>
    <div class="flex-header-with-bottom-padding">
      <div class="flex-title">
        <h3>
          Invite a new user
        </h3>
      </div>
    </div>
    <div class="table-card">
      <div class="card-body">
        <% form(action: user_path, method: :post) do %>
          <div class="form-group">
            <div>
              <p class="form-help-text">
                You can invite a new user to your project, adding them to the given subject tag (role).
              </p>
            </div>
            <div class="grid-3col" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
              <div class="col-12-5">
                <%== part("components/form/text", name: "email", type: "email", attributes: { required: true, placeholder: "Email" }) %>
              </div>
              <div class="col-12-3">
                <%== part("components/form/policy_select", name: "policy", selected: "Member", id: "invited-user-policy") %>
              </div>
              <div class="col-3-2">
                <%== part("components/form/submit_button", text: "Invite") %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <!-- User List -->
  <div>
    <% form(action: "#{user_path}/policy/managed", method: :post, id: "managed-policy") do %>
      <div class="flex-header-with-bottom-padding">
        <div class="flex-title">
          <h3>
            Users
          </h3>
        </div>
      </div>
      <div class="table-card">
        <table class="table">
          <thead class="table-header-bg">
            <tr>
              <th scope="col">Email</th>
              <th scope="col">Subject Tag</th>
              <th scope="col" class="table-header-cell"></th>
            </tr>
          </thead>
          <tbody class="table-body-bg">
            <% @users.each do |user| %>
              <tr id="user-<%= user.ubid %>">
                <td scope="row">
                  <%= user.email %>
                </td>
                <td class="table-cell-data">
                  <% if (tags = @subject_tag_map[user.id]) && tags.length >= 2 %>
                    <span title="You can manage this user's policies from the Access Control tab.">
                      <%= tags.join(", ") %>
                    </span>
                  <% elsif (tag = tags&.first) && !@allowed_remove_tag_names_map[tag] %>
                    <span id="user-<%= user.ubid %>-noremove" title="You cannot change the policy for this user">
                      <%= tag %>
                    </span>
                  <% else %>
                    <%== part(
                      "components/form/policy_select",
                      name: "user_policies[#{user.ubid}]",
                      id: "user_policy_#{user.ubid}",
                      selected: tag
                    ) %>
                  <% end %>
                </td>
                <td class="table-cell-actions">
                  <%== part(
                    "components/delete_button",
                    text: "Remove",
                    url: "#{user_path}/#{user.ubid}",
                    confirmation: user.email
                  ) %>
                </td>
              </tr>
            <% end %>
            <% @invitations.each do |invitation| %>
              <tr id="invitation-<%= invitation.email.gsub(/\W+/, "") %>">
                <td scope="row">
                  <%= invitation[:email] %>
                  <span
                    class="badge-warning"
                  >
                    Invitation expires on
                    <%= invitation.expires_at.strftime("%B %d, %Y") %>
                  </span>
                </td>
                <td class="table-cell-data">
                  <%== part("components/form/policy_select", name: "invitation_policies[#{invitation.email}]", selected: invitation.policy) %>
                </td>
                <td class="table-cell-actions">
                  <%== part(
                    "components/delete_button",
                    text: "Remove",
                    url: "#{user_path}/invitation/#{invitation.email}",
                    confirmation: invitation.email
                  ) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <div class="card-body">
          <%== part("components/form/submit_button", text: "Update") %>
        </div>
      </div>
    <% end %>
  </div>
</div>

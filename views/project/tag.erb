<% @page_title = "#{@project.name} - #{@tag.name}"

members = @current_members = {}
@tag.member_ids.each do
  next if @tag_type == "subject" && UBID.uuid_class_match?(it, ApiKey)
  members[it] = nil
end
UBID.resolve_map(members)

editable =
  !(@tag_type == "subject" && @tag.name == "Admin") &&
    has_project_permission("Project:#{@tag_type.sub(/(ect|ion)\z/, "").downcase}tag")

addition_allowed = has_permission?("#{@tag_model}:add", @authorize_id)
removal_allowed = has_permission?("#{@tag_model}:remove", @authorize_id)

add_groups = @tag_model.options_for_project(@project)
avoid = @current_members.dup
@tag.currently_included_in.each { avoid[it] = true }
avoid[@tag.id] = true
add_groups.transform_values! do |v|
  v = v.reject { avoid.include?(it.id) }
  v.map! { [it.name.to_s, it.ubid] }
  v.sort!
end
add_groups.reject! { _2.empty? }

add_checked = typecast_body_params.array(:nonempty_str, "add")
remove_checked = typecast_body_params.array(:nonempty_str, "remove")

base_path = path(@tag)
associate_path = "#{base_path}/associate"
disassociate_path = "#{base_path}/disassociate"
current_members =
  if @tag_type == "object"
    @current_members.map { [object_tag_membership_label(_2), _2.ubid] }
  else
    @current_members.map { [ace_label(_2), _2.ubid] }
  end
current_members.sort! %>
<%== render("project/user-tabbar") %>

<div class="form-group">
  <%== part(
    "components/page_header",
    title: "#{@display_tag_type} Tag: #{@tag.name}",
    breadcrumbs: [
      %w[Projects /project],
      [@project.name, @project.path],
      ["Access Control", "#{@project.path}/user/access-control"],
      ["#{@display_tag_type} Tags", "#{@project.path}/user/access-control/tag/#{@tag_type}"],
      [@tag.name, "#"]
    ]
  ) %>
</div>

<div class="content-grid">
  <% if editable %>
    <div class="table-card">
      <div class="form-section-padded form-group">
        <h3 class="card-heading"><%= "Update #{@display_tag_type} Tag" %></h3>
        <% form(action: path(@tag), method: :post) do %>
          <div class="grid-3col" style="grid-template-columns: repeat(12, minmax(0, 1fr));">
            <div class="col-span-12 md:col-span-5">
              <%== part(
                "components/form/text",
                name: "name",
                button_title: "Update",
                label: "Name",
                value: @tag.name,
                attributes: {
                  required: true,
                  placeholder: "Name"
                }
              ) %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  <div>
    <% if current_members.empty? %>
      <div class="flex-header-with-bottom-padding">
        No current members of
        <%= @tag_type %>
        tag.
      </div>
    <% else %>
      <div class="flex-header-with-bottom-padding">
        <div class="flex-title">
          <h3>Current Members</h3>
        </div>
      </div>
      <% form(action: disassociate_path, method: :post) do %>
        <div class="table-card">
          <table id="tag-membership-remove" class="table">
            <thead class="table-header-bg">
              <tr>
                <th scope="col">Name</th>
                <% if removal_allowed %>
                  <th scope="col">Remove?</th>
                <% end %>
              </tr>
            </thead>
            <tbody class="table-body-bg">
              <% current_members.each do |label, ubid| %>
                <tr id="<%= ubid %>" class="cursor-pointer">
                  <td scope="row">
                    <%== label %>
                  </td>
                  <% if removal_allowed %>
                    <td class="table-cell-actions">
                      <%== part(
                        "components/form/checkbox",
                        name: "remove[]",
                        options: [[ubid, nil, nil, ({ checked: "checked" } if remove_checked&.include?(UBID.to_uuid(ubid)))]]
                      ) %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if removal_allowed %>
          <div class="section-spacing">
            <%== part("components/form/submit_button", text: "Remove Members") %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
  <div>
    <% if addition_allowed && !add_groups.all? { _2.empty? } %>
      <div class="flex-header-with-bottom-padding">
        <div class="flex-title">
          <h3>Add Members</h3>
        </div>
      </div>
      <% form(action: associate_path, method: :post) do %>
        <div class="table-card">
          <table id="tag-membership-add" class="table">
            <thead class="table-header-bg">
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Add?</th>
              </tr>
            </thead>
            <tbody class="table-body-bg">
              <% add_groups.each do |name, available_to_add| %>
                <% name = name["label"] if name.is_a?(Hash) %>
                <tr>
                  <th colspan="2" class="tag-group-header"><%= name %></th>
                </tr>
                <% available_to_add.each do |label, ubid| %>
                  <tr id="<%= ubid %>" class="cursor-pointer">
                    <td class="table-cell-compact" scope="row">
                      <%== label %>
                    </td>
                    <td class="table-cell-actions">
                      <%== part(
                        "components/form/checkbox",
                        name: "add[]",
                        options: [[ubid, nil, nil, ({ checked: "checked" } if add_checked&.include?(ubid))]]
                      ) %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
        <div class="section-spacing">
          <%== part("components/form/submit_button", text: "Add Members") %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

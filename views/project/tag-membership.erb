<% page_action = "Update #{@display_tag_type} Tag Membership"
@page_title = "#{@project_data[:name]} - #{page_action}"

component =
  lambda do |hash|
    avoid = @current_members.dup
    @tag.currently_included_in.each { avoid[_1] = true }
    avoid[@tag.id] = true
    hash.transform_values! do |v|
      v = v.reject { avoid.include?(_1.id) }
      v.map! { [_1.name, _1.ubid] }
      v.sort_by! { _1 }
    end
    hash.reject! { _2.empty? }
    hash
  end

input_hash =
  case @tag_type
  when "subject"
    { "Tag" => @project.subject_tags.reject { _1.name == "Admin" }, "Account" => @project.accounts }
  when "action"
    {
      "Global Tag" => ActionTag.where(project_id: nil).order(:name).all,
      "Tag" => @project.action_tags,
      "Action" => ActionType
    }
  else
    {
      "Tag" => @project.object_tags,
      "Vm" => @project.vms,
      "PostgresSQL Server" => @project.postgres_resources,
      "Private Subnet" => @project.private_subnets,
      "Firewall" => @project.firewalls,
      "LoadBalancer" => @project.load_balancers
    }
  end

add_groups = component.call(input_hash)
base_path = "#{@project_data[:path]}/user/access-control/tag/#{@tag_type}/#{@tag.ubid}"
associate_path = "#{base_path}/associate"
disassociate_path = "#{base_path}/disassociate" %>
<%== render("project/user-tabbar") %>

<div class="space-y-1">
  <%== render(
    "components/page_header",
    locals: {
      title: page_action,
      breadcrumbs: [
        %w[Projects /project],
        [@project_data[:name], @project_data[:path]],
        ["Access Control", "#{@project_data[:path]}/user/access-control"],
        ["#{@display_tag_type} Tags", "#{@project_data[:path]}/user/access-control/tag/#{@tag_type}"],
        [page_action, "#"]
      ]
    }
  ) %>
</div>

<div class="grid gap-6">
  <% unless @current_members.empty? %>
    <div class="md:flex md:items-center md:justify-between pb-1 lg:pb-2">
      <div class="min-w-0 flex-1">
        <h3 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-2xl sm:tracking-tight">
          Current Members of
          <%= @display_tag_type %>
          Tag:
          <%= @tag.name %>
        </h3>
      </div>
    </div>
    <form action="<%= disassociate_path %>" method="POST">
      <%== csrf_tag(disassociate_path) %>
      <div class="overflow-hidden rounded-lg shadow ring-1 ring-black ring-opacity-5 bg-white divide-y divide-gray-200">
        <table id="tag-membership-remove" class="min-w-full divide-y divide-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Name</th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Remove?</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 bg-white">
            <% @current_members.map { [ace_label(_2), _2.ubid] }.sort.each do |label, ubid| %>
              <tr id="<%= ubid %>">
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6" scope="row">
                  <%== label %>
                </td>
                <td class="py-4 pl-3 pr-4 text-right sm:pr-6">
                  <%== render(
                    "components/form/checkbox",
                    locals: {
                      name: "remove[]",
                      options: [[ubid, nil, nil, ({ checked: "checked" } if request.params["remove"]&.include?(ubid))]]
                    }
                  ) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="px-4 py-5 sm:p-6">
        <%== render("components/form/submit_button", locals: { text: "Remove Members" }) %>
      </div>
    </form>
  <% end %>

  <% unless add_groups.all? { _2.empty? } %>
    <div class="md:flex md:items-center md:justify-between pb-1 lg:pb-2">
      <div class="min-w-0 flex-1">
        <h3 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-2xl sm:tracking-tight">
          Add Members to
          <%= @display_tag_type %>
          Tag:
          <%= @tag.name %>
        </h3>
      </div>
    </div>
    <form action="<%= associate_path %>" method="POST">
      <%== csrf_tag(associate_path) %>
      <div class="overflow-hidden rounded-lg shadow ring-1 ring-black ring-opacity-5 bg-white divide-y divide-gray-200">
        <table id="tag-membership-add" class="min-w-full divide-y divide-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Name</th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Add?</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 bg-white">
            <% add_groups.each do |name, available_to_add| %>
              <tr>
                <th colspan="2" class="text-left px-3 py-3.5"><%= name %></th>
              </tr>
              <% available_to_add.each do |label, ubid| %>
                <tr id="<%= ubid %>">
                  <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6" scope="row">
                    <%== label %>
                  </td>
                  <td class="py-4 pl-3 pr-4 text-right sm:pr-6">
                    <%== render(
                      "components/form/checkbox",
                      locals: {
                        name: "add[]",
                        options: [[ubid, nil, nil, ({ checked: "checked" } if request.params["add"]&.include?(ubid))]]
                      }
                    ) %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="px-4 py-5 sm:p-6">
        <%== render("components/form/submit_button", locals: { text: "Add Members" }) %>
      </div>
    </form>
  <% end %>
</div>

<% image_vol = @vm.vm_storage_volumes.find(&:image_backed?) %>
<% if @vm.display_state != "running" || (image_vol && !image_vol.source_fetch_complete?) %>
  <div class="auto-refresh hidden" data-interval="10"></div>
<% end %>

<% data = [
      ["ID", @vm.ubid],
      ["Name", @vm.name],
      ["Location", @vm.display_location],
      ["Size", @vm.display_size],
      ["Storage", (@vm.storage_size_gib > 0) ? "#{@vm.storage_size_gib} GB" : nil]
    ]
  if (gpu = @vm.display_gpu)
    data << ["GPU", gpu]
  end
  if image_vol
    if image_vol.source_fetch_complete?
      data << ["Disk Sync", "<span class='inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20'>Fully local</span>", { escape: false }]
    elsif image_vol.source_fetch_total
      pct = image_vol.source_fetch_percentage
      data << ["Disk Sync", "<div><div class='text-sm text-gray-600 mb-1'>#{image_vol.source_fetch_fetched}/#{image_vol.source_fetch_total} stripes (#{pct}%)</div><div class='w-full bg-gray-200 rounded-full h-2'><div class='bg-blue-500 h-2 rounded-full' style='width: #{pct}%'></div></div></div>", { escape: false }]
    else
      data << ["Disk Sync", "<span class='text-gray-500'>Waiting for status...</span>", { escape: false }]
    end
  end
  subnet = @vm.nics.first.private_subnet
  data += [
      ["IPv4", @vm.ip4_enabled ? @vm.ip4 : "Not enabled", { copyable: @vm.ip4_enabled }],
      ["IPv6", @vm.ip6, { copyable: true }],
      [
        "SSH Command",
        "<span class='bg-slate-100 text-rose-500 font-mono px-2 py-1 rounded'>#{h("ssh -i <PRIVATE_KEY_PATH> #{@vm.unix_user}@#{@vm.ip4 || @vm.ip6}")}</span>",
        { escape: false }
      ],
      ["Private IPv4", @vm.private_ipv4, { copyable: true }],
      ["Private IPv6", @vm.private_ipv6, { copyable: true }],
      [
        "Private subnet",
        "<a href='#{path(subnet)}' class='text-rose-500 hover:underline'>#{subnet.name}</a>",
        { escape: false }
      ]
    ] %>

<%== part(
  "components/kv_data_card",
  data:
) %>

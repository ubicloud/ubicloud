<% active_ver = @machine_image.active_version %>
<%== part(
  "components/kv_data_card",
  data: [
    ["ID", @machine_image.ubid],
    ["Name", @machine_image.name],
    ["Description", @machine_image.description || "-"],
    ["Location", @machine_image.display_location]
  ]
) %>

<% mi_path = "#{@project.path}#{@machine_image.path}" %>

<div class="mt-8">
  <h3 class="text-lg font-semibold text-gray-900 mb-4">Versions</h3>

  <% @versions = @machine_image.versions %>
  <%== part(
    "components/table_card",
    headers: ["Version", "State", "Active", "Size (GiB)", "Archive Size", "Created At", "Actions"],
    rows: @versions.map do |v|
      active_label = v.active? ? "<span class='inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20'>Active</span>" : "-"

      action_html = ""
      unless v.active?
        activate_html = "<form action='#{mi_path}/set-active' method='post'>#{csrf_tag(mi_path + "/set-active")}<input type='hidden' name='version_id' value='#{v.ubid}'/>" +
          part("components/button", text: "Activate", icon: nil, type: "safe") +
          "</form>"
        delete_html = part("components/delete_button",
          url: "#{mi_path}/version/#{v.ubid}",
          text: "Delete",
          confirmation: @machine_image.name,
          icon: nil
        )
        delete_html = part("components/delete_button",
          url: "#{mi_path}/version/#{v.ubid}",
          text: "Delete",
          confirmation: @machine_image.name,
          icon: nil
        )
        action_html = "<div class='flex flex-col gap-2'>#{activate_html} #{delete_html}</div>"
      end

      [
        [
          v.version,
          ["machine_image_state_label", {component: { state: v.state }}],
          [active_label, {escape: false}],
          v.size_gib ? "#{v.size_gib} GiB" : "-",
          v.archive_size_mib ? "#{v.archive_size_mib} MiB" : "-",
          v.created_at&.strftime("%B %d, %Y %H:%M UTC"),
          [action_html, {escape: false}]
        ],
        {id: "ver-#{v.ubid}"}
      ]
    end,
    empty_state: {
      icon: "hero-x-circle",
      title: "No versions",
      description: "This image has no versions yet."
    }
  ) %>

  <% if has_permission?("MachineImage:edit", @machine_image) %>
    <div class="mt-4">
      <%== part("components/button", text: "Add Version", icon: "hero-plus", link: "#{mi_path}/create-version") %>
    </div>
  <% end %>
</div>
